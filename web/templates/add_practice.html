{% extends "base.html" %}

{% block title %}Add Practice{% endblock %}

{% block content %}
<h2>Add New Practice</h2>

<form method="POST" enctype="multipart/form-data" style="max-width: 900px;">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
        <div class="form-group">
            <label for="practice_sanskrit">Sanskrit Name</label>
            <input type="text" id="practice_sanskrit" name="practice_sanskrit" 
                   placeholder="e.g., Shavasana" autocomplete="off">
            <div id="autocomplete-results" style="position: relative;"></div>
        </div>
        
        <div class="form-group">
            <label for="practice_english">English Name *</label>
            <input type="text" id="practice_english" name="practice_english" required
                   placeholder="e.g., Corpse pose">
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
        <div class="form-group">
            <label for="practice_segment">Category *</label>
            <select id="practice_segment" name="practice_segment" required>
                <option value="">Select Category</option>
                <option value="Preparatory Practice">Preparatory Practice</option>
                <option value="Breathing Practice">Breathing Practice</option>
                <option value="Sequential Yogic Practice">Sequential Yogic Practice</option>
                <option value="Yogasana">Yogasana</option>
                <option value="Pranayama">Pranayama</option>
                <option value="Meditation">Meditation</option>
                <option value="Chanting">Chanting</option>
                <option value="Additional Practices">Additional Practices</option>
                <option value="Kriya (Cleansing Techniques)">Kriya (Cleansing Techniques)</option>
                <option value="Yogic Counselling">Yogic Counselling</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="sub_category">Sub-Category</label>
            <input type="text" id="sub_category" name="sub_category" 
                   placeholder="e.g., standing_asana, pranayama_practices">
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr; gap: 1.5rem; margin-bottom: 2rem;">
        <div class="form-group">
            <label for="kosha">Kosha *</label>
            <select id="kosha" name="kosha" required>
                <option value="">Select Kosha</option>
                <option value="Annamaya Kosha">Annamaya Kosha</option>
                <option value="Pranamaya Kosha">Pranamaya Kosha</option>
                <option value="Manomaya Kosha">Manomaya Kosha</option>
                <option value="Vijnanamaya Kosha">Vijnanamaya Kosha</option>
                <option value="Anandamaya Kosha">Anandamaya Kosha</option>
            </select>
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
        <div class="form-group">
            <label for="rounds">Rounds</label>
            <input type="number" id="rounds" name="rounds" placeholder="e.g., 5">
        </div>
        
        <div class="form-group">
            <label for="time_minutes">Duration (minutes)</label>
            <input type="number" step="0.5" id="time_minutes" name="time_minutes" placeholder="e.g., 2">
        </div>
        
        <div class="form-group">
            <label for="strokes_per_min">Strokes/Min</label>
            <input type="number" id="strokes_per_min" name="strokes_per_min" placeholder="If applicable">
        </div>
    </div>
    
    <div class="form-group">
        <label for="description">Description</label>
        <textarea id="description" name="description" 
                  placeholder="Brief description of the practice"></textarea>
    </div>
    
    <div class="form-group">
        <label>How to do!</label>
        <button type="button" class="btn btn-secondary" onclick="addVariationField()" style="margin-bottom: 1rem;">Add Variation</button>
        <div id="variations-container"></div>
    </div>
    
    <div style="padding: 1.5rem; background: #f8f9fa; border-radius: 8px; margin-bottom: 2rem;">
        <h4 style="margin-bottom: 1rem;">Media Attachments</h4>
        
        <div class="form-group">
            <label for="photo">Attach Photo</label>
            <input type="file" id="photo" name="photo" accept="image/*">
        </div>
        
        <div class="form-group">
            <label for="video">Attach Video</label>
            <input type="file" id="video" name="video" accept="video/*">
        </div>
    </div>
    
    <div style="padding: 1.5rem; background: #f8f9fa; border-radius: 8px; margin-bottom: 2rem;">
        <h4 style="margin-bottom: 1rem;">Associate with Diseases</h4>
        <p style="color: #666; margin-bottom: 1rem;">Select which diseases use this practice:</p>
        
        {% for disease in diseases %}
        <div style="margin-bottom: 1rem; padding: 1rem; background: white; border-radius: 6px; border: 1px solid #ddd;">
            <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 0.5rem;">
                <input type="checkbox" name="diseases" value="{{ disease.id }}" 
                       class="disease-checkbox" data-disease-id="{{ disease.id }}"
                       style="margin-right: 0.5rem;">
                <strong>{{ disease.name }}</strong>
            </label>
            <div id="module-selection-{{ disease.id }}" style="display: none; margin-left: 1.5rem; margin-top: 0.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: #666;">
                    Module Referred From:
                </label>
                <input type="text" name="module_name_{{ disease.id }}" 
                       id="module_input_{{ disease.id }}"
                       placeholder="Type module name (e.g., Naveen et al., 2013)" 
                       autocomplete="off" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                <input type="hidden" name="module_id_{{ disease.id }}" id="module_id_{{ disease.id }}">
                <div id="module-autocomplete-{{ disease.id }}" style="position: relative;"></div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <div style="display: flex; gap: 1rem;">
        <button type="submit" class="btn">Add Practice</button>
        <a href="/" class="btn btn-secondary">Cancel</a>
    </div>
</form>

<script>
let variationCount = 0;

function addVariationField() {
    variationCount++;
    const container = document.getElementById('variations-container');
    const div = document.createElement('div');
    div.id = `variation-${variationCount}`;
    div.style.display = 'grid';
    div.style.gridTemplateColumns = '2fr 1fr';
    div.style.gap = '1rem';
    div.style.marginBottom = '1rem';
    div.innerHTML = `
        <div>
            <input type="text" name="variation_${variationCount}" 
                   placeholder="Variation description" required>
        </div>
        <div>
            <input type="text" name="variation_ref_${variationCount}" 
                   placeholder="Referred in (paper/book)">
            <button type="button" onclick="removeVariation(${variationCount})" 
                    class="btn btn-secondary" style="margin-left: 0.5rem;">Remove</button>
        </div>
    `;
    container.appendChild(div);
}

function removeVariation(id) {
    const elem = document.getElementById(`variation-${id}`);
    if (elem) elem.remove();
}

// Category to Kosha mapping
const categoryToKosha = {
    'Preparatory Practice': 'Annamaya Kosha',
    'Yogasana': 'Annamaya Kosha',
    'Kriya (Cleansing Techniques)': 'Annamaya Kosha',
    'Sequential Yogic Practice': 'Annamaya Kosha',
    'Breathing Practice': 'Pranamaya Kosha',
    'Pranayama': 'Pranamaya Kosha',
    'Meditation': 'Manomaya Kosha',
    'Chanting': 'Manomaya Kosha',
    'Yogic Counselling': 'Vijnanamaya Kosha',
    'Additional Practices': ''  // Can be left empty or determined by user
};

// Auto-fill Kosha based on Category selection
const categorySelect = document.getElementById('practice_segment');
const koshaSelect = document.getElementById('kosha');

if (categorySelect && koshaSelect) {
    categorySelect.addEventListener('change', function() {
        const selectedCategory = this.value;
        const mappedKosha = categoryToKosha[selectedCategory];
        if (mappedKosha) {
            koshaSelect.value = mappedKosha;
        }
    });
}

// Autocomplete functionality for Sanskrit name
let autocompleteTimeout;
let currentPractices = [];
let selectedIndex = -1;
const sanskritInput = document.getElementById('practice_sanskrit');
const autocompleteDiv = document.getElementById('autocomplete-results');

sanskritInput.addEventListener('input', function() {
    clearTimeout(autocompleteTimeout);
    const query = this.value.trim();
    selectedIndex = -1;
    
    if (query.length < 1) {
        autocompleteDiv.innerHTML = '';
        currentPractices = [];
        return;
    }
    
    autocompleteTimeout = setTimeout(() => {
        fetch(`/api/practice/search?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                currentPractices = data;
                displayAutocompleteResults(data);
            });
    }, 300);
});

// Keyboard navigation
sanskritInput.addEventListener('keydown', function(e) {
    if (autocompleteDiv.innerHTML === '') return;
    
    const items = autocompleteDiv.querySelectorAll('.autocomplete-item');
    
    switch(e.key) {
        case 'ArrowDown':
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
            updateSelection();
            break;
        case 'ArrowUp':
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, -1);
            updateSelection();
            break;
        case 'Enter':
            e.preventDefault();
            if (selectedIndex >= 0 && selectedIndex < items.length) {
                selectPractice(currentPractices[selectedIndex].id);
            }
            break;
        case 'Escape':
            autocompleteDiv.innerHTML = '';
            currentPractices = [];
            selectedIndex = -1;
            break;
    }
});

function updateSelection() {
    const items = autocompleteDiv.querySelectorAll('.autocomplete-item');
    items.forEach((item, index) => {
        if (index === selectedIndex) {
            item.style.backgroundColor = '#e3f2fd';
            item.style.borderLeft = '3px solid #2196f3';
        } else {
            item.style.backgroundColor = '';
            item.style.borderLeft = '';
        }
    });
}

function displayAutocompleteResults(practices) {
    if (practices.length === 0) {
        autocompleteDiv.innerHTML = '';
        return;
    }
    
    autocompleteDiv.innerHTML = '<div style="background: white; border: 1px solid #ddd; border-radius: 5px; max-height: 300px; overflow-y: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: absolute; width: 100%; z-index: 1000;">' +
        practices.map((p, index) => `
            <div class="autocomplete-item" style="padding: 0.7rem; cursor: pointer; border-bottom: 1px solid #eee;" 
                 onclick="event.stopPropagation(); selectPractice(${p.id});" data-index="${index}">
                <strong>${p.practice_sanskrit || 'No Sanskrit name'}</strong><br>
                <small>${p.practice_english}</small>
            </div>
        `).join('') +
        '</div>';
}

function selectPractice(id) {
    const practice = currentPractices.find(p => p.id === id);
    if (practice) {
        // Close autocomplete immediately to prevent any visual issues
        autocompleteDiv.innerHTML = '';
        currentPractices = [];
        selectedIndex = -1;
        
        // Fill all fields except media attachments
        document.getElementById('practice_sanskrit').value = practice.practice_sanskrit || '';
        document.getElementById('practice_english').value = practice.practice_english;
        
        // Fill Category (practice_segment)
        const practiceSegmentField = document.getElementById('practice_segment');
        if (practiceSegmentField && practice.practice_segment) {
            practiceSegmentField.value = practice.practice_segment;
        }
        
        // Fill Kosha
        const koshaField = document.getElementById('kosha');
        if (koshaField && practice.kosha) {
            koshaField.value = practice.kosha;
        } else if (koshaField && practiceSegmentField && practice.practice_segment) {
            // Auto-fill kosha based on category if not provided
            const categoryToKosha = {
                'Preparatory Practice': 'Annamaya Kosha',
                'Yogasana': 'Annamaya Kosha',
                'Kriya (Cleansing Techniques)': 'Annamaya Kosha',
                'Sequential Yogic Practice': 'Annamaya Kosha',
                'Breathing Practice': 'Pranamaya Kosha',
                'Pranayama': 'Pranamaya Kosha',
                'Meditation': 'Manomaya Kosha',
                'Chanting': 'Manomaya Kosha',
                'Yogic Counselling': 'Vijnanamaya Kosha',
                'Additional Practices': ''
            };
            const mappedKosha = categoryToKosha[practice.practice_segment];
            if (mappedKosha) {
                koshaField.value = mappedKosha;
            }
        }
        
        document.getElementById('sub_category').value = practice.sub_category || '';
        document.getElementById('rounds').value = practice.rounds || '';
        document.getElementById('time_minutes').value = practice.time_minutes || '';
        document.getElementById('strokes_per_min').value = practice.strokes_per_min || '';
        document.getElementById('strokes_per_cycle').value = practice.strokes_per_cycle || '';
        document.getElementById('rest_between_cycles_sec').value = practice.rest_between_cycles_sec || '';
        document.getElementById('description').value = practice.description || '';
        
        // Clear existing variations first
        const variationsContainer = document.getElementById('variations-container');
        if (variationsContainer) {
            variationsContainer.innerHTML = '';
            variationCount = 0;
            
            // Handle variations
            if (practice.variations) {
                try {
                    const variations = JSON.parse(practice.variations);
                    if (variations && variations.length > 0) {
                        variations.forEach((v, idx) => {
                            addVariationField();
                            const variationInput = document.getElementsByName(`variation_${variationCount}`)[0];
                            const refInput = document.getElementsByName(`variation_ref_${variationCount}`)[0];
                            if (variationInput) variationInput.value = v.text || v;
                            if (refInput) refInput.value = v.referred_in || '';
                        });
                    }
                } catch (e) {
                    // Old format - simple array
                    try {
                        const variations = typeof practice.variations === 'string' ? JSON.parse(practice.variations) : [];
                        if (variations && variations.length > 0) {
                            variations.forEach((v, idx) => {
                                addVariationField();
                                const variationInput = document.getElementsByName(`variation_${variationCount}`)[0];
                                if (variationInput) variationInput.value = v;
                            });
                        }
                    } catch (e2) {
                        console.error('Error parsing variations:', e2);
                    }
                }
            }
        }
        
        // Move focus to the next field (English Name)
        document.getElementById('practice_english').focus();
    }
}

        // Close autocomplete when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('#practice_sanskrit') && !e.target.closest('#autocomplete-results')) {
        autocompleteDiv.innerHTML = '';
        currentPractices = [];
        selectedIndex = -1;
    }
});

// Module selection for each disease
document.querySelectorAll('.disease-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const diseaseId = this.dataset.diseaseId;
        const moduleSelection = document.getElementById(`module-selection-${diseaseId}`);
        const moduleInput = document.getElementById(`module_input_${diseaseId}`);
        const moduleIdInput = document.getElementById(`module_id_${diseaseId}`);
        const autocompleteDiv = document.getElementById(`module-autocomplete-${diseaseId}`);
        
        if (this.checked) {
            moduleSelection.style.display = 'block';
            // Initialize autocomplete for this disease
            initModuleAutocomplete(diseaseId, moduleInput, moduleIdInput, autocompleteDiv);
        } else {
            moduleSelection.style.display = 'none';
            moduleInput.value = '';
            moduleIdInput.value = '';
            autocompleteDiv.innerHTML = '';
        }
    });
});

function initModuleAutocomplete(diseaseId, input, hiddenInput, autocompleteDiv) {
    let autocompleteTimeout;
    let currentModules = [];
    let selectedIndex = -1;
    
    input.addEventListener('input', function() {
        clearTimeout(autocompleteTimeout);
        const query = this.value.trim();
        selectedIndex = -1;
        
        if (query.length < 1) {
            autocompleteDiv.innerHTML = '';
            currentModules = [];
            hiddenInput.value = '';
            return;
        }
        
        autocompleteTimeout = setTimeout(() => {
            fetch(`/api/module/search?q=${encodeURIComponent(query)}&disease_id=${diseaseId}`)
                .then(response => response.json())
                .then(data => {
                    currentModules = data;
                    displayModuleAutocompleteResults(data, autocompleteDiv);
                });
        }, 300);
    });
    
    input.addEventListener('keydown', function(e) {
        if (autocompleteDiv.innerHTML === '') return;
        
        const items = autocompleteDiv.querySelectorAll('.autocomplete-item');
        
        switch(e.key) {
            case 'ArrowDown':
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                updateModuleSelection(items, selectedIndex);
                break;
            case 'ArrowUp':
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateModuleSelection(items, selectedIndex);
                break;
            case 'Enter':
                e.preventDefault();
                if (selectedIndex >= 0 && selectedIndex < items.length) {
                    selectModuleLocal(currentModules[selectedIndex].id, currentModules[selectedIndex].name);
                }
                break;
            case 'Escape':
                autocompleteDiv.innerHTML = '';
                currentModules = [];
                selectedIndex = -1;
                break;
        }
    });
    
    function displayModuleAutocompleteResults(modules, div) {
        if (modules.length === 0) {
            div.innerHTML = '';
            return;
        }
        
        div.innerHTML = '<div style="background: white; border: 1px solid #ddd; border-radius: 5px; max-height: 300px; overflow-y: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: absolute; width: 100%; z-index: 1000;">' +
            modules.map((m, index) => {
                const escapedName = m.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                return `
                <div class="autocomplete-item" style="padding: 0.7rem; cursor: pointer; border-bottom: 1px solid #eee;" 
                     onclick="selectModuleForDisease(${diseaseId}, ${m.id}, '${escapedName}')" data-index="${index}">
                    <strong>${m.name}</strong>
                </div>
            `;
            }).join('') +
            '</div>';
    }
    
    function updateModuleSelection(items, index) {
        items.forEach((item, idx) => {
            if (idx === index) {
                item.style.backgroundColor = '#e3f2fd';
                item.style.borderLeft = '3px solid #2196f3';
            } else {
                item.style.backgroundColor = '';
                item.style.borderLeft = '';
            }
        });
    }
    
    function selectModuleLocal(id, name) {
        input.value = name;
        hiddenInput.value = id;
        autocompleteDiv.innerHTML = '';
        currentModules = [];
        selectedIndex = -1;
    }
    
    // Store the select function for this disease
    window[`selectModuleForDisease_${diseaseId}`] = selectModuleLocal;
    
    // Close autocomplete when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest(input) && !e.target.closest(autocompleteDiv)) {
            autocompleteDiv.innerHTML = '';
            currentModules = [];
            selectedIndex = -1;
        }
    });
}

// Global function to select module for a disease
function selectModuleForDisease(diseaseId, moduleId, moduleName) {
    const selectFunc = window[`selectModuleForDisease_${diseaseId}`];
    if (selectFunc) {
        selectFunc(moduleId, moduleName);
    }
}
</script>

<style>
.autocomplete-item:hover {
    background: #f0f0f0;
}
</style>
{% endblock %}
