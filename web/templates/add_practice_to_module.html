{% extends "base.html" %}

{% block title %}Add Practice to Module{% endblock %}

{% block content %}
<style>
.compact-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
    gap: 0.9rem;
}

.compact-grid.three {
    grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
}

.compact-grid .form-group input,
.compact-grid .form-group select {
    padding: 0.4rem 0.5rem;
    font-size: 0.9rem;
}

.existing-practices {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin: 0.75rem 0 0 0;
}

.existing-practice-chip {
    background: #edf2f7;
    color: #2d3748;
    padding: 0.35rem 0.7rem;
    border-radius: 999px;
    font-size: 0.85rem;
}
</style>

<div style="margin-bottom: 2rem; padding: 1.5rem; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #2196F3;">
    <h3 style="margin: 0 0 0.5rem 0; color: #2c3e50;">Adding Practice to Module</h3>
    <p style="margin: 0; color: #555;">
        <strong>Module:</strong> 
        {% if module.paper_link %}
            <a href="{{ module.paper_link }}" target="_blank" style="color: #667eea; text-decoration: none;">
                {{ module.developed_by or 'N/A' }}
            </a>
        {% else %}
            {{ module.developed_by or 'N/A' }}
        {% endif %}
        <br>
        <strong>Disease:</strong> {{ module.disease.name if module.disease else 'N/A' }}
    </p>
    <p style="margin: 0.5rem 0 0 0; color: #666; font-size: 0.9rem;">
        This practice will be automatically associated with the disease: <strong>{{ module.disease.name if module.disease else 'N/A' }}</strong>
    </p>

    {% if existing_practices %}
    <div style="margin-top: 1rem;">
        <strong style="color: #2c3e50;">Practices already in this module:</strong>
        <div class="existing-practices">
            {% for practice in existing_practices %}
                <span class="existing-practice-chip">
                    {{ practice.sanskrit or practice.english }}
                </span>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<h2>Add Practice to Module</h2>

<form method="POST" style="max-width: 900px;">
    <div class="compact-grid" style="margin-bottom: 1.25rem;">
        <div class="form-group">
            <label for="practice_sanskrit">Sanskrit Name</label>
            <input type="text" id="practice_sanskrit" name="practice_sanskrit" 
                   placeholder="e.g., Shavasana" autocomplete="off">
            <div id="autocomplete-results" style="position: relative;"></div>
        </div>
        
        <div class="form-group">
            <label for="practice_english">English Name *</label>
            <input type="text" id="practice_english" name="practice_english" required
                   placeholder="e.g., Corpse pose">
        </div>
        
        <div class="form-group">
            <label for="code">Practice Code</label>
            <div style="position: relative;">
                <input type="text" id="code" name="code" 
                       placeholder="e.g., SHA01 (auto-filled)" maxlength="50" autocomplete="off">
                <div id="code-autocomplete-results" style="position: relative;"></div>
            </div>
            <div id="code-validation-message" style="margin-top: 0.3rem; font-size: 0.85rem;"></div>
            <small style="color: #666; display: block; margin-top: 0.3rem; font-size: 0.85rem;">
                Code for this practice. Same code is used for practices with the same Sanskrit name. Type a code to auto-fill all fields.
            </small>
        </div>
    </div>
    
    <div class="compact-grid three" style="margin-bottom: 1.25rem;">
        <div class="form-group">
            <label for="practice_segment">Category *</label>
            <select id="practice_segment" name="practice_segment" required>
                <option value="">Select Category</option>
                {% for segment in practice_segments %}
                <option value="{{ segment }}">{{ segment }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="sub_category">Sub-Category</label>
            <input type="text" id="sub_category" name="sub_category" 
                   placeholder="e.g., standing_asana, pranayama_practices">
        </div>
        <div class="form-group">
            <label for="kosha">Kosha *</label>
            <select id="kosha" name="kosha" required>
                <option value="">Select Kosha</option>
                <option value="Annamaya Kosha">Annamaya Kosha</option>
                <option value="Pranamaya Kosha">Pranamaya Kosha</option>
                <option value="Manomaya Kosha">Manomaya Kosha</option>
                <option value="Vijnanamaya Kosha">Vijnanamaya Kosha</option>
                <option value="Anandamaya Kosha">Anandamaya Kosha</option>
            </select>
        </div>
    </div>
    
    <div class="compact-grid three" style="margin-bottom: 1.25rem;">
        <div class="form-group">
            <label for="rounds">Rounds</label>
            <input type="number" id="rounds" name="rounds" placeholder="e.g., 5">
        </div>
        
        <div class="form-group">
            <label for="time_minutes">Duration (minutes)</label>
            <input type="number" step="0.5" id="time_minutes" name="time_minutes" placeholder="e.g., 2">
        </div>
        <div class="form-group">
            <label for="strokes_per_min">Strokes (if applicable)</label>
            <input type="number" id="strokes_per_min" name="strokes_per_min" placeholder="If applicable">
        </div>
    </div>

    <div class="compact-grid" style="margin-bottom: 1.25rem;">
        <div class="form-group">
            <label for="cvr_score">CVR Score</label>
            <input type="number" step="0.01" id="cvr_score" name="cvr_score" placeholder="e.g., 0.82">
        </div>
    </div>
    
    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
        <button type="submit" name="add_another" value="no" class="btn">Finish module</button>
        <button type="submit" name="add_another" value="yes" class="btn btn-secondary">Add Another Practice</button>
        <a href="/module/{{ module.id }}" class="btn btn-secondary">Cancel</a>
    </div>
</form>

<script>
// Autocomplete functionality for Sanskrit name
let autocompleteTimeout;
let currentPractices = [];
let selectedIndex = -1;
const sanskritInput = document.getElementById('practice_sanskrit');
const autocompleteDiv = document.getElementById('autocomplete-results');

// Category to Kosha mapping
const categoryToKosha = {
    'Preparatory Practice': 'Annamaya Kosha',
    'Yogasana': 'Annamaya Kosha',
    'Kriya (Cleansing Techniques)': 'Annamaya Kosha',
    'Sequential Yogic Practice': 'Annamaya Kosha',
    'Breathing Practice': 'Pranamaya Kosha',
    'Pranayama': 'Pranamaya Kosha',
    'Meditation': 'Manomaya Kosha',
    'Chanting': 'Manomaya Kosha',
    'Yogic Counselling': 'Vijnanamaya Kosha',
    'Additional Practices': ''  // Can be left empty or determined by user
};

// Auto-fill Kosha based on Category selection
const categorySelect = document.getElementById('practice_segment');
const koshaSelect = document.getElementById('kosha');

if (categorySelect && koshaSelect) {
    categorySelect.addEventListener('change', function() {
        const selectedCategory = this.value;
        const mappedKosha = categoryToKosha[selectedCategory];
        if (mappedKosha) {
            koshaSelect.value = mappedKosha;
        }
    });
}

if (sanskritInput) {
    sanskritInput.addEventListener('input', function() {
        clearTimeout(autocompleteTimeout);
        const query = this.value.trim();
        selectedIndex = -1;
        
        if (query.length < 1) {
            autocompleteDiv.innerHTML = '';
            currentPractices = [];
            return;
        }
        
        autocompleteTimeout = setTimeout(() => {
            fetch(`/api/practice/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    currentPractices = data;
                    displayAutocompleteResults(data);
                });
        }, 300);
    });
    
    // Keyboard navigation
    sanskritInput.addEventListener('keydown', function(e) {
        if (autocompleteDiv.innerHTML === '') return;
        
        const items = autocompleteDiv.querySelectorAll('.autocomplete-item');
        
        switch(e.key) {
            case 'ArrowDown':
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                updateSelection();
                break;
            case 'ArrowUp':
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateSelection();
                break;
            case 'Enter':
                e.preventDefault();
                if (selectedIndex >= 0 && selectedIndex < items.length) {
                    selectPractice(currentPractices[selectedIndex].id);
                    document.getElementById('practice_english').focus();
                }
                break;
            case 'Escape':
                autocompleteDiv.innerHTML = '';
                currentPractices = [];
                selectedIndex = -1;
                break;
        }
    });
}

function updateSelection() {
    const items = autocompleteDiv.querySelectorAll('.autocomplete-item');
    items.forEach((item, index) => {
        if (index === selectedIndex) {
            item.style.backgroundColor = '#e3f2fd';
            item.style.borderLeft = '3px solid #2196f3';
        } else {
            item.style.backgroundColor = '';
            item.style.borderLeft = '';
        }
    });
}

function displayAutocompleteResults(practices) {
    if (practices.length === 0) {
        autocompleteDiv.innerHTML = '';
        return;
    }
    
    autocompleteDiv.innerHTML = '<div style="background: white; border: 1px solid #ddd; border-radius: 5px; max-height: 300px; overflow-y: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: absolute; width: 100%; z-index: 1000;">' +
        practices.map((p, index) => `
            <div class="autocomplete-item" style="padding: 0.7rem; cursor: pointer; border-bottom: 1px solid #eee;" 
                 onclick="selectPractice(${p.id})" data-index="${index}">
                <strong>${p.practice_sanskrit || 'No Sanskrit name'}</strong><br>
                <small>${p.practice_english}</small>
            </div>
        `).join('') +
        '</div>';
}

function selectPractice(id) {
    const practice = currentPractices.find(p => p.id === id);
    if (practice) {
        // Close autocomplete immediately
        autocompleteDiv.innerHTML = '';
        currentPractices = [];
        selectedIndex = -1;
        
        document.getElementById('practice_sanskrit').value = practice.practice_sanskrit || '';
        document.getElementById('practice_english').value = practice.practice_english;
        
        // Fill Code
        const codeField = document.getElementById('code');
        if (codeField && practice.code) {
            codeField.value = practice.code;
        }
        
        // Fill Category (practice_segment)
        const practiceSegmentField = document.getElementById('practice_segment');
        if (practiceSegmentField && practice.practice_segment) {
            practiceSegmentField.value = practice.practice_segment;
        }
        
        // Fill Kosha
        const koshaField = document.getElementById('kosha');
        if (koshaField && practice.kosha) {
            koshaField.value = practice.kosha;
        } else if (koshaField && practiceSegmentField && practice.practice_segment) {
            // Auto-fill kosha based on category if not provided
            const categoryToKosha = {
                'Preparatory Practice': 'Annamaya Kosha',
                'Yogasana': 'Annamaya Kosha',
                'Kriya (Cleansing Techniques)': 'Annamaya Kosha',
                'Sequential Yogic Practice': 'Annamaya Kosha',
                'Breathing Practice': 'Pranamaya Kosha',
                'Pranayama': 'Pranamaya Kosha',
                'Meditation': 'Manomaya Kosha',
                'Chanting': 'Manomaya Kosha',
                'Yogic Counselling': 'Vijnanamaya Kosha',
                'Additional Practices': ''
            };
            const mappedKosha = categoryToKosha[practice.practice_segment];
            if (mappedKosha) {
                koshaField.value = mappedKosha;
            }
        }
        
        document.getElementById('sub_category').value = practice.sub_category || '';
        document.getElementById('rounds').value = practice.rounds || '';
        document.getElementById('time_minutes').value = practice.time_minutes || '';
        document.getElementById('strokes_per_min').value = practice.strokes_per_min || '';
        // Don't autofill CVR score - it's module-specific, so it should be different for different modules
        // document.getElementById('cvr_score').value = practice.cvr_score || '';
        document.getElementById('practice_english').focus();
    }
}

document.addEventListener('click', function(e) {
    if (!e.target.closest('#practice_sanskrit') && !e.target.closest('#autocomplete-results')) {
        autocompleteDiv.innerHTML = '';
        currentPractices = [];
        selectedIndex = -1;
    }
    if (!e.target.closest('#code') && !e.target.closest('#code-autocomplete-results')) {
        codeAutocompleteDiv.innerHTML = '';
        codeCurrentPractices = [];
        codeSelectedIndex = -1;
    }
});

// Autocomplete functionality for Code field
let codeAutocompleteTimeout;
let codeCurrentPractices = [];
let codeSelectedIndex = -1;
const codeInput = document.getElementById('code');
const codeAutocompleteDiv = document.getElementById('code-autocomplete-results');

if (codeInput) {
    codeInput.addEventListener('input', function() {
        clearTimeout(codeAutocompleteTimeout);
        const query = this.value.trim();
        codeSelectedIndex = -1;
        
        if (query.length < 1) {
            codeAutocompleteDiv.innerHTML = '';
            codeCurrentPractices = [];
            return;
        }
        
        codeAutocompleteTimeout = setTimeout(() => {
            fetch(`/api/practice/search?q=${encodeURIComponent(query)}&search_by=code`)
                .then(response => response.json())
                .then(data => {
                    codeCurrentPractices = data;
                    displayCodeAutocompleteResults(data);
                });
        }, 300);
    });
    
    // Keyboard navigation for code autocomplete
    codeInput.addEventListener('keydown', function(e) {
        if (codeAutocompleteDiv.innerHTML === '') return;
        
        const items = codeAutocompleteDiv.querySelectorAll('.autocomplete-item');
        
        switch(e.key) {
            case 'ArrowDown':
                e.preventDefault();
                codeSelectedIndex = Math.min(codeSelectedIndex + 1, items.length - 1);
                updateCodeSelection();
                break;
            case 'ArrowUp':
                e.preventDefault();
                codeSelectedIndex = Math.max(codeSelectedIndex - 1, -1);
                updateCodeSelection();
                break;
            case 'Enter':
                e.preventDefault();
                if (codeSelectedIndex >= 0 && codeSelectedIndex < items.length) {
                    selectPracticeByCode(codeCurrentPractices[codeSelectedIndex].id);
                    document.getElementById('practice_english').focus();
                }
                break;
            case 'Escape':
                codeAutocompleteDiv.innerHTML = '';
                codeCurrentPractices = [];
                codeSelectedIndex = -1;
                break;
        }
    });
}

function updateCodeSelection() {
    const items = codeAutocompleteDiv.querySelectorAll('.autocomplete-item');
    items.forEach((item, index) => {
        if (index === codeSelectedIndex) {
            item.style.backgroundColor = '#e3f2fd';
            item.style.borderLeft = '3px solid #2196f3';
        } else {
            item.style.backgroundColor = '';
            item.style.borderLeft = '';
        }
    });
}

function displayCodeAutocompleteResults(practices) {
    if (practices.length === 0) {
        codeAutocompleteDiv.innerHTML = '';
        return;
    }
    
    codeAutocompleteDiv.innerHTML = '<div style="background: white; border: 1px solid #ddd; border-radius: 5px; max-height: 300px; overflow-y: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: absolute; width: 100%; z-index: 1000;">' +
        practices.map((p, index) => `
            <div class="autocomplete-item" style="padding: 0.7rem; cursor: pointer; border-bottom: 1px solid #eee;" 
                 onclick="selectPracticeByCode(${p.id})" data-index="${index}">
                <strong>${p.code || 'No code'}</strong> - ${p.practice_sanskrit || 'No Sanskrit name'}<br>
                <small>${p.practice_english}</small>
            </div>
        `).join('') +
        '</div>';
    updateCodeSelection();
}

function selectPracticeByCode(id) {
    const practice = codeCurrentPractices.find(p => p.id === id);
    if (practice) {
        // Close autocomplete immediately
        codeAutocompleteDiv.innerHTML = '';
        codeCurrentPractices = [];
        codeSelectedIndex = -1;
        
        // Fill all fields using the existing selectPractice function logic
        document.getElementById('code').value = practice.code || '';
        document.getElementById('practice_sanskrit').value = practice.practice_sanskrit || '';
        document.getElementById('practice_english').value = practice.practice_english;
        
        // Clear validation message after autofill
        if (validationMessageDivForValidation) {
            validationMessageDivForValidation.innerHTML = '';
            validationMessageDivForValidation.style.display = 'none';
        }
        
        // Fill Category (practice_segment)
        const practiceSegmentField = document.getElementById('practice_segment');
        if (practiceSegmentField && practice.practice_segment) {
            practiceSegmentField.value = practice.practice_segment;
        }
        
        // Fill Kosha
        const koshaField = document.getElementById('kosha');
        if (koshaField && practice.kosha) {
            koshaField.value = practice.kosha;
        } else if (koshaField && practiceSegmentField && practice.practice_segment) {
            // Auto-fill kosha based on category if not provided
            const categoryToKosha = {
                'Preparatory Practice': 'Annamaya Kosha',
                'Yogasana': 'Annamaya Kosha',
                'Kriya (Cleansing Techniques)': 'Annamaya Kosha',
                'Sequential Yogic Practice': 'Annamaya Kosha',
                'Breathing Practice': 'Pranamaya Kosha',
                'Pranayama': 'Pranamaya Kosha',
                'Meditation': 'Manomaya Kosha',
                'Chanting': 'Manomaya Kosha',
                'Yogic Counselling': 'Vijnanamaya Kosha',
                'Additional Practices': ''
            };
            const mappedKosha = categoryToKosha[practice.practice_segment];
            if (mappedKosha) {
                koshaField.value = mappedKosha;
            }
        }
        
        document.getElementById('sub_category').value = practice.sub_category || '';
        document.getElementById('rounds').value = practice.rounds || '';
        document.getElementById('time_minutes').value = practice.time_minutes || '';
        document.getElementById('strokes_per_min').value = practice.strokes_per_min || '';
        // Don't autofill CVR score - it's module-specific, so it should be different for different modules
        // document.getElementById('cvr_score').value = practice.cvr_score || '';
        document.getElementById('practice_english').focus();
        
        // Clear validation message after autofill
        if (validationMessageDivForValidation) {
            validationMessageDivForValidation.innerHTML = '';
            validationMessageDivForValidation.style.display = 'none';
        }
    }
}

// Real-time validation for code/Sanskrit name consistency
let validationTimeout;
const codeInputForValidation = document.getElementById('code');
const sanskritNameInputForValidation = document.getElementById('practice_sanskrit');
const validationMessageDivForValidation = document.getElementById('code-validation-message');

function validateCodeSanskrit() {
    clearTimeout(validationTimeout);
    const code = (codeInputForValidation ? codeInputForValidation.value : '').trim();
    const sanskrit = (sanskritNameInputForValidation ? sanskritNameInputForValidation.value : '').trim();
    
    // Clear previous validation message
    if (validationMessageDivForValidation) {
        validationMessageDivForValidation.innerHTML = '';
        validationMessageDivForValidation.style.display = 'none';
    }
    
    // Only validate if at least one field has content
    if (!code && !sanskrit) {
        return;
    }
    
    // Debounce validation
    validationTimeout = setTimeout(() => {
        fetch(`/api/practice/validate-code-sanskrit?code=${encodeURIComponent(code)}&sanskrit_name=${encodeURIComponent(sanskrit)}`)
            .then(response => response.json())
            .then(data => {
                if (!data.valid && data.message && validationMessageDivForValidation) {
                    // Show validation error
                    validationMessageDivForValidation.innerHTML = `<span style="color: #dc3545;">⚠️ ${data.message}</span>`;
                    validationMessageDivForValidation.style.display = 'block';
                    
                    // If there's a suggested code, auto-fill it (for sanskrit_code_mismatch)
                    if (data.conflict_type === 'sanskrit_code_mismatch' && data.existing_code && codeInputForValidation && codeInputForValidation.value !== data.existing_code) {
                        // Don't auto-fill if user is actively typing code
                        // Only auto-fill if code field is empty or was auto-filled
                        if (!codeInputForValidation.value || codeInputForValidation.value === code) {
                            codeInputForValidation.value = data.existing_code;
                            // Re-validate with new code
                            setTimeout(() => validateCodeSanskrit(), 100);
                        }
                    }
                } else if (validationMessageDivForValidation) {
                    // Clear validation message
                    validationMessageDivForValidation.innerHTML = '';
                    validationMessageDivForValidation.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Validation error:', error);
            });
    }, 500); // Wait 500ms after user stops typing
}

// Add event listeners for real-time validation
if (codeInputForValidation) {
    codeInputForValidation.addEventListener('input', validateCodeSanskrit);
    codeInputForValidation.addEventListener('blur', validateCodeSanskrit);
}

if (sanskritNameInputForValidation) {
    sanskritNameInputForValidation.addEventListener('input', validateCodeSanskrit);
    sanskritNameInputForValidation.addEventListener('blur', validateCodeSanskrit);
}
</script>

<style>
.autocomplete-item:hover {
    background: #f0f0f0;
}
</style>
{% endblock %}

