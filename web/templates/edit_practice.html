{% extends "base.html" %}

{% block title %}Edit Practice{% endblock %}

{% block content %}
<h2>Edit Practice</h2>

<form method="POST" enctype="multipart/form-data" style="max-width: 900px;">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
        <div class="form-group">
            <label for="practice_sanskrit">Sanskrit Name</label>
            <div style="position: relative;">
                <input type="text" id="practice_sanskrit" name="practice_sanskrit" 
                       value="{{ practice.practice_sanskrit or '' }}" placeholder="e.g., Shavasana">
                <div id="autocomplete-results" style="position: relative;"></div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="practice_english">English Name *</label>
            <input type="text" id="practice_english" name="practice_english" required
                   value="{{ practice.practice_english }}" placeholder="e.g., Corpse pose">
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
        <div class="form-group">
            <label for="kosa">Kosa *</label>
            <select id="kosa" name="kosa" required>
                <option value="">Select Kosa</option>
                <option value="Annamaya_Kosa" {% if practice.kosa == 'Annamaya_Kosa' %}selected{% endif %}>Annamaya Kosa</option>
                <option value="Pranamaya_Kosa" {% if practice.kosa == 'Pranamaya_Kosa' %}selected{% endif %}>Pranamaya Kosa</option>
                <option value="Manomaya_Kosa" {% if practice.kosa == 'Manomaya_Kosa' %}selected{% endif %}>Manomaya Kosa</option>
                <option value="Vijnanamaya_Kosa" {% if practice.kosa == 'Vijnanamaya_Kosa' %}selected{% endif %}>Vijnanamaya Kosa</option>
                <option value="Anandamaya_Kosa" {% if practice.kosa == 'Anandamaya_Kosa' %}selected{% endif %}>Anandamaya Kosa</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="sub_category">Sub-Category</label>
            <input type="text" id="sub_category" name="sub_category" 
                   value="{{ practice.sub_category or '' }}" placeholder="e.g., standing_asana, pranayama_practices">
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
        <div class="form-group">
            <label for="rounds">Rounds</label>
            <input type="number" id="rounds" name="rounds" value="{{ practice.rounds or '' }}" placeholder="e.g., 5">
        </div>
        
        <div class="form-group">
            <label for="time_minutes">Duration (minutes)</label>
            <input type="number" step="0.5" id="time_minutes" name="time_minutes" 
                   value="{{ practice.time_minutes or '' }}" placeholder="e.g., 2">
        </div>
        
        <div class="form-group">
            <label for="strokes_per_min">Strokes/Min</label>
            <input type="number" id="strokes_per_min" name="strokes_per_min" 
                   value="{{ practice.strokes_per_min or '' }}" placeholder="If applicable">
        </div>
    </div>
    
    <div class="form-group">
        <label for="description">Description</label>
        <textarea id="description" name="description" 
                  placeholder="Brief description of the practice">{{ practice.description or '' }}</textarea>
    </div>
    
    <div class="form-group">
        <label for="how_to_do">How to Do This Practice *</label>
        <textarea id="how_to_do" name="how_to_do" required
                  placeholder="Detailed instructions on how to perform this practice">{{ practice.how_to_do or '' }}</textarea>
    </div>
    
    <div class="form-group" id="variations-container">
        <label>Variations</label>
        <button type="button" class="btn btn-secondary" onclick="addVariationField()" style="margin-bottom: 1rem;">Add Variation</button>
        <div id="variations">
            {% if practice.variations %}
                {% set vars = (practice.variations|from_json) if practice.variations else [] %}
                {% for var in vars %}
                    <div id="variation-{{ loop.index }}" style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <input type="text" name="variation_{{ loop.index }}" value="{{ var.text if var is mapping else var }}">
                        </div>
                        <div>
                            <input type="text" name="variation_ref_{{ loop.index }}" value="{{ var.referred_in if var is mapping else '' }}">
                            <button type="button" onclick="removeVariation({{ loop.index }})" class="btn btn-secondary" style="margin-left: 0.5rem;">Remove</button>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        </div>
    </div>
    
    <div style="padding: 1.5rem; background: #f8f9fa; border-radius: 8px; margin-bottom: 2rem;">
        <h4 style="margin-bottom: 1rem;">Media Attachments</h4>
        
        <div class="form-group">
            <label for="photo">Attach Photo</label>
            <input type="file" id="photo" name="photo" accept="image/*">
            {% if practice.photo_path %}
            <p style="margin-top: 0.5rem; color: #666;">Current: <a href="{{ practice.photo_path }}" target="_blank">View photo</a></p>
            {% endif %}
        </div>
        
        <div class="form-group">
            <label for="video">Attach Video</label>
            <input type="file" id="video" name="video" accept="video/*">
            {% if practice.video_path %}
            <p style="margin-top: 0.5rem; color: #666;">Current: <a href="{{ practice.video_path }}" target="_blank">View video</a></p>
            {% endif %}
        </div>
    </div>
    
    <div style="padding: 1.5rem; background: #f8f9fa; border-radius: 8px; margin-bottom: 2rem;">
        <h4 style="margin-bottom: 1rem;">Associate with Diseases</h4>
        <p style="color: #666; margin-bottom: 1rem;">Select which diseases use this practice:</p>
        
        {% for disease in diseases %}
        <div style="margin-bottom: 0.5rem;">
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" name="diseases" value="{{ disease.id }}" 
                       {% if disease in practice.diseases %}checked{% endif %}
                       style="margin-right: 0.5rem;">
                {{ disease.name }}
            </label>
        </div>
        {% endfor %}
    </div>
    
    <div style="display: flex; gap: 1rem;">
        <button type="submit" class="btn">Update Practice</button>
        <a href="/practices" class="btn btn-secondary">Cancel</a>
    </div>
</form>

<script>
let variationCount = {{ (practice.variations|from_json)|length if practice.variations else 0 }};

function addVariationField() {
    variationCount++;
    const container = document.getElementById('variations');
    const div = document.createElement('div');
    div.id = `variation-${variationCount}`;
    div.style.display = 'grid';
    div.style.gridTemplateColumns = '2fr 1fr';
    div.style.gap = '1rem';
    div.style.marginBottom = '1rem';
    div.innerHTML = `
        <div>
            <input type="text" name="variation_${variationCount}" placeholder="Variation description">
        </div>
        <div>
            <input type="text" name="variation_ref_${variationCount}" placeholder="Referred in (paper/book)">
            <button type="button" onclick="removeVariation(${variationCount})" class="btn btn-secondary" style="margin-left: 0.5rem;">Remove</button>
        </div>
    `;
    container.appendChild(div);
}

function removeVariation(id) {
    const elem = document.getElementById(`variation-${id}`);
    if (elem) elem.remove();
}

// Autocomplete functionality for Sanskrit name
let autocompleteTimeout;
let currentPractices = [];
let selectedIndex = -1;
const sanskritInput = document.getElementById('practice_sanskrit');
const autocompleteDiv = document.getElementById('autocomplete-results');

sanskritInput.addEventListener('input', function() {
    clearTimeout(autocompleteTimeout);
    const query = this.value.trim();
    selectedIndex = -1;
    
    if (query.length < 1) {
        autocompleteDiv.innerHTML = '';
        currentPractices = [];
        return;
    }
    
    autocompleteTimeout = setTimeout(() => {
        fetch(`/api/practice/search?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                currentPractices = data;
                displayAutocompleteResults(data);
            });
    }, 300);
});

// Keyboard navigation
sanskritInput.addEventListener('keydown', function(e) {
    if (autocompleteDiv.innerHTML === '') return;
    
    const items = autocompleteDiv.querySelectorAll('.autocomplete-item');
    
    switch(e.key) {
        case 'ArrowDown':
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
            updateSelection();
            break;
        case 'ArrowUp':
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, -1);
            updateSelection();
            break;
        case 'Enter':
            e.preventDefault();
            if (selectedIndex >= 0 && selectedIndex < items.length) {
                selectPractice(currentPractices[selectedIndex].id);
                // Move focus to the next field (English Name)
                document.getElementById('practice_english').focus();
            }
            break;
        case 'Escape':
            autocompleteDiv.innerHTML = '';
            currentPractices = [];
            selectedIndex = -1;
            break;
    }
});

function updateSelection() {
    const items = autocompleteDiv.querySelectorAll('.autocomplete-item');
    items.forEach((item, index) => {
        if (index === selectedIndex) {
            item.style.backgroundColor = '#e3f2fd';
            item.style.borderLeft = '3px solid #2196f3';
        } else {
            item.style.backgroundColor = '';
            item.style.borderLeft = '';
        }
    });
}

function displayAutocompleteResults(practices) {
    if (practices.length === 0) {
        autocompleteDiv.innerHTML = '';
        return;
    }
    
    autocompleteDiv.innerHTML = '<div style="background: white; border: 1px solid #ddd; border-radius: 5px; max-height: 300px; overflow-y: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: absolute; width: 100%; z-index: 1000;">' +
        practices.map((p, index) => `
            <div class="autocomplete-item" style="padding: 0.7rem; cursor: pointer; border-bottom: 1px solid #eee;" 
                 onclick="selectPractice(${p.id})" data-index="${index}">
                <strong>${p.practice_sanskrit || 'No Sanskrit name'}</strong><br>
                <small>${p.practice_english}</small>
            </div>
        `).join('') +
        '</div>';
}

function selectPractice(id) {
    const practice = currentPractices.find(p => p.id === id);
    if (practice) {
        // Fill all fields except media attachments
        document.getElementById('practice_sanskrit').value = practice.practice_sanskrit || '';
        document.getElementById('practice_english').value = practice.practice_english;
        document.getElementById('kosa').value = practice.kosa;
        document.getElementById('sub_category').value = practice.sub_category || '';
        document.getElementById('rounds').value = practice.rounds || '';
        document.getElementById('time_minutes').value = practice.time_minutes || '';
        document.getElementById('strokes_per_min').value = practice.strokes_per_min || '';
        document.getElementById('strokes_per_cycle').value = practice.strokes_per_cycle || '';
        document.getElementById('rest_between_cycles_sec').value = practice.rest_between_cycles_sec || '';
        document.getElementById('description').value = practice.description || '';
        document.getElementById('how_to_do').value = practice.how_to_do || '';
        
        // Clear existing variations first
        const variationsContainer = document.getElementById('variations');
        variationsContainer.innerHTML = '';
        variationCount = 0;
        
        // Handle variations
        if (practice.variations) {
            try {
                const variations = JSON.parse(practice.variations);
                if (variations && variations.length > 0) {
                    variations.forEach((v, idx) => {
                        addVariationField();
                        document.getElementsByName(`variation_${variationCount}`)[0].value = v.text || v;
                        document.getElementsByName(`variation_ref_${variationCount}`)[0].value = v.referred_in || '';
                    });
                }
            } catch (e) {
                // Old format - simple array
                const variations = typeof practice.variations === 'string' ? JSON.parse(practice.variations) : [];
                if (variations && variations.length > 0) {
                    variations.forEach((v, idx) => {
                        addVariationField();
                        document.getElementsByName(`variation_${variationCount}`)[0].value = v;
                    });
                }
            }
        }
        
        // Clear autocomplete and reset
        autocompleteDiv.innerHTML = '';
        currentPractices = [];
        selectedIndex = -1;
        
        // Move focus to the next field (English Name)
        document.getElementById('practice_english').focus();
    }
}

// Close autocomplete when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('#practice_sanskrit') && !e.target.closest('#autocomplete-results')) {
        autocompleteDiv.innerHTML = '';
        currentPractices = [];
        selectedIndex = -1;
    }
});
</script>

<style>
.autocomplete-item:hover {
    background: #f0f0f0;
}
</style>
{% endblock %}


