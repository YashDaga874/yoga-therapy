{% extends "base.html" %}

{% block title %}Edit Contraindication{% endblock %}

{% block content %}
<style>
.text-toolbar {
    display: flex;
    gap: 0.4rem;
    margin-bottom: 0.4rem;
}

.format-btn {
    padding: 0.3rem 0.55rem;
    border: 1px solid #cbd5e0;
    border-radius: 4px;
    background: #f8f9fa;
    cursor: pointer;
    font-size: 0.85rem;
    min-width: 2.2rem;
}

.format-btn:hover {
    background: #e2e8f0;
}

.rich-text-editor {
    min-height: 140px;
    border: 1px solid #cbd5e0;
    border-radius: 6px;
    padding: 0.65rem;
    font-size: 0.95rem;
    line-height: 1.5;
    background: white;
}

.rich-text-editor:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.15);
}

.readonly-box {
    background: #f1f3f5;
    padding: 0.75rem 1rem;
    border-radius: 6px;
    border: 1px solid #e2e8f0;
    color: #2c3e50;
}
</style>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <h2>Edit Contraindication</h2>
    <form method="POST" action="/contraindication/{{ contraindication.id }}/delete" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this contraindication?');">
        <button type="submit" class="btn" style="background: #dc3545;">Delete</button>
    </form>
</div>

<div style="margin-bottom: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #e2e8f0;">
    {% if selected_disease %}
    <p style="margin: 0 0 0.4rem 0; color: #495057;"><strong>Disease:</strong> {{ selected_disease.name }}</p>
    {% endif %}
    <p style="margin: 0; color: #495057;">
        <strong>Practice:</strong>
        {% if contraindication.practice_sanskrit %}
            {{ contraindication.practice_sanskrit }}
            <span style="color: #666; font-weight: normal;">({{ contraindication.practice_english }})</span>
        {% else %}
            {{ contraindication.practice_english }}
        {% endif %}
    </p>
</div>

<form method="POST" id="edit-contra-form" style="max-width: 900px;">
    <input type="hidden" name="reason" id="reason">
    <input type="hidden" name="reference_full" id="reference_full">

    <div class="form-group">
        <label>Reason for Contraindication</label>
        <div class="text-toolbar" data-editor="reason-editor">
            <button type="button" class="format-btn" data-command="bold"><strong>B</strong></button>
            <button type="button" class="format-btn" data-command="italic"><em>I</em></button>
            <button type="button" class="format-btn" data-command="underline"><span style="text-decoration: underline;">U</span></button>
        </div>
        <div id="reason-editor" class="rich-text-editor" contenteditable="true">{{ (contraindication.reason or '')|safe }}</div>
    </div>

    <h3 style="margin: 2rem 0 1rem 0;">Reference</h3>

    <div class="form-group">
        <label>Reference (APA 7th edition)</label>
        <div class="text-toolbar" data-editor="reference-editor">
            <button type="button" class="format-btn" data-command="bold"><strong>B</strong></button>
            <button type="button" class="format-btn" data-command="italic"><em>I</em></button>
            <button type="button" class="format-btn" data-command="underline"><span style="text-decoration: underline;">U</span></button>
            <button type="button" class="format-btn" data-command="link">Link</button>
        </div>
        <div id="reference-editor" class="rich-text-editor" contenteditable="true">{{ (contraindication.apa_citation or '')|safe }}</div>
    </div>

    <div class="compact-grid" style="margin-bottom: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
        <div class="form-group">
            <label for="parenthetical_citation">Parenthetical (APA 7th edition)</label>
            <input type="text" id="parenthetical_citation" name="parenthetical_citation" value="{{ contraindication.source_type or '' }}" placeholder="e.g., Thirthalli et al., 2013">
        </div>
        <div class="form-group">
            <label for="reference_link">Link</label>
            <input type="url" id="reference_link" name="reference_link" value="{{ contraindication.source_name or '' }}" placeholder="https://doi.org/...">
        </div>
    </div>

    <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
        <button type="submit" class="btn">Save Changes</button>
        <a href="/contraindications" class="btn btn-secondary">Cancel</a>
    </div>
</form>

<script>
const reasonEditor = document.getElementById('reason-editor');
const reasonHidden = document.getElementById('reason');
const referenceEditor = document.getElementById('reference-editor');
const referenceHidden = document.getElementById('reference_full');
const editForm = document.getElementById('edit-contra-form');

function syncEditor(editor, hiddenInput) {
    hiddenInput.value = editor.innerHTML.trim();
}

reasonEditor.addEventListener('input', () => syncEditor(reasonEditor, reasonHidden));
referenceEditor.addEventListener('input', () => syncEditor(referenceEditor, referenceHidden));

editForm.addEventListener('submit', () => {
    syncEditor(reasonEditor, reasonHidden);
    syncEditor(referenceEditor, referenceHidden);
});

function attachToolbarListeners(toolbarSelector) {
    document.querySelectorAll(`${toolbarSelector} .format-btn`).forEach(button => {
        button.addEventListener('click', event => {
            event.preventDefault();
            const command = button.dataset.command;
            const editorId = toolbarSelector === '[data-editor="reason-editor"]' ? 'reason-editor' : 'reference-editor';
            const editor = document.getElementById(editorId);
            editor.focus();
            if (command === 'link') {
                const url = prompt('Enter URL to link to:');
                if (url) {
                    document.execCommand('createLink', false, url);
                }
            } else {
                document.execCommand(command, false, null);
            }
            if (toolbarSelector === '[data-editor="reason-editor"]') {
                syncEditor(reasonEditor, reasonHidden);
            } else {
                syncEditor(referenceEditor, referenceHidden);
            }
        });
    });
}

attachToolbarListeners('[data-editor="reason-editor"]');
attachToolbarListeners('[data-editor="reference-editor"]');

// initialise hidden inputs
syncEditor(reasonEditor, reasonHidden);
syncEditor(referenceEditor, referenceHidden);
</script>
{% endblock %}
