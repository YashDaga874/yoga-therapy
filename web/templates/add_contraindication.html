{% extends "base.html" %}

{% block title %}Add Contraindication{% endblock %}

{% block content %}
<h2>Add Contraindication</h2>

<form method="POST" style="max-width: 800px;">
    <div class="form-group">
        <label for="practice_sanskrit">Practice Name (Sanskrit)</label>
        <input type="text" id="practice_sanskrit" name="practice_sanskrit" 
               placeholder="e.g., Shavasana" autocomplete="off">
        <div id="autocomplete-results" style="position: relative;"></div>
    </div>
    
    <div class="form-group">
        <label for="practice_english">Practice Name (English) *</label>
        <input type="text" id="practice_english" name="practice_english" required
               placeholder="e.g., Corpse pose">
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
        <div class="form-group">
            <label for="practice_segment">Practice Segment *</label>
            <select id="practice_segment" name="practice_segment" required>
                <option value="">Select Practice Segment</option>
                <option value="Preparatory Practice">Preparatory Practice</option>
                <option value="Breathing Practice">Breathing Practice</option>
                <option value="Suryanamaskara">Suryanamaskara</option>
                <option value="Yogasana">Yogasana</option>
                <option value="Pranayama">Pranayama</option>
                <option value="Meditation">Meditation</option>
                <option value="Additional Practices">Additional Practices</option>
                <option value="Kriya (Cleansing Techniques)">Kriya (Cleansing Techniques)</option>
                <option value="Yogic Counselling">Yogic Counselling</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="sub_category">Sub-Category</label>
            <input type="text" id="sub_category" name="sub_category">
        </div>
    </div>
    
    <div class="form-group">
        <label for="reason">Reason for Contraindication</label>
        <textarea id="reason" name="reason" 
                  placeholder="Why is this practice contraindicated?"></textarea>
    </div>
    
    <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Source Information</h3>
    
    <div class="form-group">
        <label for="source_type">Type of Source *</label>
        <select id="source_type" name="source_type" required>
            <option value="">Select Source Type</option>
            <option value="book">Book</option>
            <option value="paper">Research Paper</option>
            <option value="ancient_text">Ancient Text</option>
        </select>
    </div>
    
    <div class="form-group">
        <label for="source_name">Name of Source / Link *</label>
        <input type="text" id="source_name" name="source_name" required
               placeholder="Book name, paper title, or link">
    </div>
    
    <div class="form-group" id="page-number-group" style="display: none;">
        <label for="page_number">Page Number / Range</label>
        <input type="text" id="page_number" name="page_number" 
               placeholder="e.g., 45 or 45-47">
    </div>
    
    <div class="form-group" id="apa-citation-group" style="display: none;">
        <label for="apa_citation">APA Citation</label>
        <textarea id="apa_citation" name="apa_citation" 
                  placeholder="Full APA citation format"></textarea>
    </div>
    
    <div style="padding: 1.5rem; background: #f8f9fa; border-radius: 8px; margin-bottom: 1.5rem;">
        <h4 style="margin-bottom: 1rem;">For Which Diseases *</h4>
        <p style="color: #666; margin-bottom: 1rem;">Select which disease(s) this contraindication applies to:</p>
        
        {% for disease in diseases %}
        <div style="margin-bottom: 0.5rem;">
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" name="diseases" value="{{ disease.id }}" 
                       style="margin-right: 0.5rem;">
                {{ disease.name }}
            </label>
        </div>
        {% endfor %}
    </div>
    
    <div style="display: flex; gap: 1rem;">
        <button type="submit" class="btn">Add Contraindication</button>
        <a href="/" class="btn btn-secondary">Cancel</a>
    </div>
</form>

<script>
// Autocomplete functionality for Sanskrit name
let autocompleteTimeout;
const sanskritInput = document.getElementById('practice_sanskrit');
const autocompleteDiv = document.getElementById('autocomplete-results');

sanskritInput.addEventListener('input', function() {
    clearTimeout(autocompleteTimeout);
    const query = this.value.trim();
    
    if (query.length < 1) {
        autocompleteDiv.innerHTML = '';
        return;
    }
    
    autocompleteTimeout = setTimeout(() => {
        fetch(`/api/practice/search?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                displayAutocompleteResults(data);
            });
    }, 300);
});

function displayAutocompleteResults(practices) {
    if (practices.length === 0) {
        autocompleteDiv.innerHTML = '';
        return;
    }
    
    autocompleteDiv.innerHTML = '<div style="background: white; border: 1px solid #ddd; border-radius: 5px; max-height: 300px; overflow-y: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: absolute; width: 100%; z-index: 1000;">' +
        practices.map(p => `
            <div class="autocomplete-item" style="padding: 0.7rem; cursor: pointer; border-bottom: 1px solid #eee;" onclick="selectPractice(${p.id})">
                <strong>${p.practice_sanskrit || 'No Sanskrit name'}</strong><br>
                <small>${p.practice_english}</small>
            </div>
        `).join('') +
        '</div>';
}

function selectPractice(id) {
    fetch(`/api/practice/search?q=` + document.getElementById('practice_sanskrit').value)
        .then(response => response.json())
        .then(data => {
            const practice = data.find(p => p.id === id);
            if (practice) {
                document.getElementById('practice_sanskrit').value = practice.practice_sanskrit || '';
                document.getElementById('practice_english').value = practice.practice_english;
                document.getElementById('practice_segment').value = practice.practice_segment;
                document.getElementById('sub_category').value = practice.sub_category || '';
                autocompleteDiv.innerHTML = '';
            }
        });
}

// Close autocomplete when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('#practice_sanskrit') && !e.target.closest('#autocomplete-results')) {
        autocompleteDiv.innerHTML = '';
    }
});

// Toggle page number and APA citation fields based on source type
document.getElementById('source_type').addEventListener('change', function() {
    const sourceType = this.value;
    const pageNumberGroup = document.getElementById('page-number-group');
    const apaCitationGroup = document.getElementById('apa-citation-group');
    
    if (sourceType === 'book') {
        pageNumberGroup.style.display = 'block';
        apaCitationGroup.style.display = 'block';
    } else if (sourceType === 'paper') {
        pageNumberGroup.style.display = 'none';
        apaCitationGroup.style.display = 'block';
    } else {
        pageNumberGroup.style.display = 'none';
        apaCitationGroup.style.display = 'none';
    }
});
</script>

<style>
.autocomplete-item:hover {
    background: #f0f0f0;
}
</style>
{% endblock %}
